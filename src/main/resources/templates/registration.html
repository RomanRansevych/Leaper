<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Leaper</title>
    <link th:href="@{/css/registration-style.css}" rel="stylesheet" type="text/css"/>
</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

<body class="text-center">
<header>
    <div class="title">Leaper</div>
</header>

<h2 th:value="${allUsername}" id="users" class="text_h">Enter your data</h2>

<form method="post">
    <div class="form">
        <input class="form-input" type="text" id="username" name="username" placeholder="Login">
        <br>
        <input class="form-input" type="password" id="password_one" name="password" placeholder="Password">
        <br>
        <input class="form-input" type="password" id="password_two" name="password" placeholder="Repeat password">
        <br>
        <button onclick="location.href='http://localhost:3245/leaper/login'" type="button" class="form-button" id="sign-in-button">Log in</button>
        <button onclick="sendJSON()" type="button" class="form-button" id="registration-button">Create account</button>
    </div>
</form>

<!-- скрипт, который обработает нажатие на кнопку и отправит данные на сервер -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var allUsername = /*[[${allUsername}]]*/ "allUsername";
    /*]]>*/
    // эта функция сработает при нажатии на кнопку-->
    function sendJSON() {

        // с помощью jQuery обращаемся к элементам на странице по их именам
        // let allUsername = document.getElementById("users");
        // let allUsername = "${}";
        let username = document.querySelector('#username');
        let passwordOne = document.querySelector('#password_one');
        let passwordTwo = document.querySelector('#password_two');
        let isOk = 1;

        if (username.value !== "") {
            if (passwordOne.value === passwordTwo.value) {
                for (let i = 0; i < allUsername.length; i++) {
                    if (allUsername[i] === username.value) {
                        isOk = 0;
                    }
                }
                if (isOk === 0) {
                    alert("This login is already in use");
                } else {
                    // а вот сюда мы поместим ответ от сервера
                    // let result = document.querySelector('.result');
                    // создаём новый экземпляр запроса XHR
                    let xhr = new XMLHttpRequest();
                    // адрес, куда мы отправим нашу JSON-строку
                    let url = "http://localhost:3245/api/users";
                    // открываем соединение
                    xhr.open("POST", url, true);
                    // устанавливаем заголовок — выбираем тип контента, который отправится на сервер, в нашем случае мы явно пишем, что это JSON
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.responseType = 'text';
                    // преобразуем наши данные JSON в строку
                    var data = JSON.stringify({"login": username.value, "password": passwordOne.value});
                    // когда всё готово, отправляем JSON на сервер
                    xhr.send(data);

                    location.href='http://localhost:3245/leaper/login';
                }
            } else {
                alert("Password doesn't match");
            }
        } else {
            alert("Username is empty");
        }
    }
</script>

</body>
</html>